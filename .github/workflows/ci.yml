name: CI workflow

on:
  workflow_dispatch:
    inputs:
      scratch_username:
        description: 'when input, connected to username for scratch'
        required: false
        type: string

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - name: install salesforce cli
      env:
        filename_installer: sf-linux-x64.tar.gz
      run: |
        declare dir_install=${HOME}/.local/sf
        cd /tmp
        wget https://developer.salesforce.com/media/salesforce-cli/sf/channels/stable/${filename_installer}
        mkdir -p "${dir_install}"
        tar -xzf ${filename_installer} -C "${dir_install}" --strip-components 1
        echo "${dir_install}/bin" >> $GITHUB_PATH

    - name: confirm sf version
      run: |
        sf version

    - name: checkout
      uses: actions/checkout@v3

    - name: install sfdx-lwc-jest by npm
      run: |
        npm install
    
    - name: run jest
      run: |
        sf force lightning lwc test run

    - name: generate private key from encoded private key
      env:
        encoded_private_key_content: ${{ secrets.encoded_private_key_content }}
        encode_raw_key: ${{ secrets.encode_raw_key }}
        encode_iv: ${{ secrets.encode_iv }}
        encoded_private_key_file: "/tmp/server.pem.enc"
        decoded_private_key_file: "/tmp/server.pem"
      run: |
        echo ${encoded_private_key_content} | base64 -d > ${encoded_private_key_file}
        openssl enc -nosalt -aes-256-cbc -d -in ${encoded_private_key_file} -out ${decoded_private_key_file} -base64 -K ${encode_raw_key} -iv ${encode_iv}

    - name: authorize devhub org
      env:
        devhub_username: ${{ secrets.devhub_username }}
        devhub_client_id: ${{ secrets.devhub_client_id }}
        decoded_private_key_file: "/tmp/server.pem"
      run: |
        sf auth jwt grant --client-id ${devhub_client_id} --jwt-key-file ${decoded_private_key_file} --username ${devhub_username} --set-default-dev-hub --alias devhub --json
        sf org list
    
    - name: create scratch org
      if: ${{ inputs.scratch_username == '' }}
      run: |
        sf org create scratch --definition-file config/project-scratch-def.json --set-default --alias scratch --json

    - name: authorize scratch org
      if: ${{ inputs.scratch_username != '' }}
      env:
        devhub_client_id: ${{ secrets.devhub_client_id }}
        scratch_username: ${{ inputs.scratch_username }}
        decoded_private_key_file: "/tmp/server.pem"
      run: |
        sf auth jwt grant --client-id ${devhub_client_id} --jwt-key-file ${decoded_private_key_file} --username ${scratch_username} --instance-url https://test.salesforce.com --set-default --alias scratch --json

    - name: show org list
      run: sf org list

    - name: deploy to scratch org
      run: sf project deploy start --ignore-conflicts

    - name: run apex test 
      run: sf apex run test --code-coverage --synchronous --result-format json --output-dir /tmp/build/apex-test-results

    - name: archive apext test results
      run: |
        cd /tmp/build
        zip -r /tmp/apex-test-results.zip apex-test-results

    - name: upload apex test results
      uses: actions/upload-artifact@v3
      with:
        name: apex-test-results
        path: /tmp/apex-test-results.zip
